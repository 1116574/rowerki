<style>
    #map { height: 100%;}
</style>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
crossorigin=""/>


 <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin="">
</script>

<div id="map"></div>

<script src="stations.js"></script>
<script src="gps.js"></script>

<script>
    var map = L.map('map').setView([52.22, 21.00], 13);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: 'pk.eyJ1IjoicGF3ZWwxMTE2NTc0IiwiYSI6ImNsM2Fydmh5dTA0ZHczYnA0c3lseWlyZmEifQ.gKQTMlWndPolQFJM1lvgUQ'
}).addTo(map);

var myIcon = L.icon({
    iconUrl: 'marker.png',
    iconSize: [32, 64],
    iconAnchor: [16, 64],
    popupAnchor: [32, -64],
});

var myRedIcon = L.icon({
    iconUrl: 'red_icon.png',
    iconSize: [32, 64],
    iconAnchor: [16, 64],
    popupAnchor: [32, -64],
});


var toggle = false;
var all_markers = []
for (const index in stations['data']['stations']) {
    const station = stations['data']['stations'][index]
    // console.log(station);
    
    // var marker = L.marker([station['lat'], station['lon']]).addTo(map);
    var marker = L.marker([station['lat'], station['lon']]);
    marker.bindPopup(station['name']);
    marker.on('click', function() {
        fetch('http://localhost:8080/' + station['station_id'])
            .then(response => response.json())
            .then(data => {
                map.removeLayer(all_markers_layer);
                // map.removeLayer(in_markers_layer);
                console.log(data)
                in_markers = []
                for (const index in data['results']) {
                    const station = data['results'][index]
                    if (station['duration'] == 0){  // kind of a hack - if duration is 0 then its referencing itself, so we use a different icon
                        var new_marker = L.marker([gps[station['id']][0], gps[station['id']][1]], {icon: myIcon});
                    } else if (station['duration'] > 1100) {
                        var new_marker = L.marker([gps[station['id']][0], gps[station['id']][1]], {icon: myRedIcon});
                    } else {
                        var new_marker = L.marker([gps[station['id']][0], gps[station['id']][1]]);
                    }
                    
                    new_marker.on('click', function() {
                        map.removeLayer(in_markers_layer);
                        all_markers_layer.addTo(map);
                    })
                    in_markers.push(new_marker);
                }
                var in_markers_layer = L.layerGroup(in_markers).addTo(map);
            });

    });

    all_markers.push(marker);
}

var all_markers_layer = L.layerGroup(all_markers).addTo(map);


</script>