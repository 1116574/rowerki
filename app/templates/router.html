<style>
    body {
        height: 100%;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: 1fr;
        grid-column-gap: 0px;
        grid-row-gap: 0px; 
    }
    #map {
        height: 100%;
        grid-area: 1 / 2 / 2 / 4;
        /* cursor: url('cursor_start.png'), auto; */
    }
    #controls {
        grid-area: 1 / 1 / 2 / 2;;
    }
</style>


<link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
crossorigin=""/>


<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin="">
</script>

<div id="controls">
    <input type="text" id="from">
    <input type="text" id="to">
    <ol id="list">
        <!-- <li> Tu będą przystanki</li> -->
    </ol>
</div>
<div id="map"></div>

<script src="{{ url_for('static', filename='stations.js') }}"></script>
<script src="{{ url_for('static', filename='station_names.js') }}"></script>
<script src="{{ url_for('static', filename='gps.js') }}"></script>

<script>
    var map = L.map('map').setView([52.22, 21.00], 13);
    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox/streets-v11',
    tileSize: 512,
    zoomOffset: -1,
    accessToken: '{{ mapbox_access_token }}'
}).addTo(map);

var startIcon = L.icon({
    iconUrl: "{{ url_for('static', filename='green_flag.png') }}",
    iconSize: [25, 25],
    iconAnchor: [12, 25],
    popupAnchor: [12, -25],
});

var endIcon = L.icon({
    iconUrl: "{{ url_for('static', filename='finish_flag.png') }}",
    iconSize: [25, 25],
    iconAnchor: [12, 25],
    popupAnchor: [12, -25],
});


var mode = 'from'
var all_markers_layer = L.layerGroup();
var starting_station = 0;

const url = window.location.href

function draw_markers(start_id=0, finish_id=0){
    var all_markers = []
    if(all_markers_layer){
        map.removeLayer(all_markers_layer)
    }

    for (const index in stations) {
        const station = stations[index]

        switch (station['station_id']) {
            case start_id:
                var marker = L.marker([station['lat'], station['lon']], {icon: startIcon});
                break;
            case finish_id:
                var marker = L.marker([station['lat'], station['lon']], {icon: endIcon});
                break;
            default:
                var marker = L.marker([station['lat'], station['lon']]);
                break;
        }

        // var marker = L.marker([station['lat'], station['lon']], {icon: startIcon});
        // var marker = L.marker([station['lat'], station['lon']]);
        marker.bindPopup(station['name']);
        marker.on('click', function() {
            if(mode == 'from'){
                document.getElementById('from').value = station['name']
                starting_station = station['station_id']
                console.log('from')
                console.log(station['station_id'])
                mode = 'to'

                // Redraw markers
                draw_markers(start_id=station['station_id'], finish_id=0);
            } else {
                document.getElementById('to').value = station['name']
                console.log('to')
                console.log(station['station_id'])

                draw_markers(start_id=starting_station, finish_id=station['station_id']);
                fetch(url + '/dijkstra/' + starting_station + '/' + station['station_id'])
                    .then(response => response.json())
                    .then(data => {
                        draw_route_markers(data['route'])
                        var ul = document.getElementById("list");
                        console.log(data['step_by_step'])
                        for(const index in data['step_by_step']){
                            var li = document.createElement("li");
                            li.appendChild(document.createTextNode(data['step_by_step'][index]));
                            ul.appendChild(li);
                        }  
                    })

            }
        });
        // console.log(marker)
        all_markers.push(marker);
    }
    all_markers_layer = L.layerGroup(all_markers).addTo(map);
    return all_markers_layer
}

function draw_route_markers(route){
    var point_list = []
    var marker_list = []

    for (const index in route) {
        var station = station_names[route[index]]
        console.log(station)
        
        // For poly line
        var point = new L.LatLng(station['lat'], station['lon'])
        point_list.push(point)

        // For markers
        var marker = L.marker([station['lat'], station['lon']]);
        marker.bindPopup(station['name']);
        marker_list.push(marker)
    }

    var firstpolyline = new L.Polyline(point_list, {
        color: 'red',
        weight: 3,
        opacity: 0.5,
        smoothFactor: 1
    });
    firstpolyline.addTo(map);

    if(all_markers_layer){
        map.removeLayer(all_markers_layer)
    }
    var route_markers = L.layerGroup(marker_list).addTo(map);

}

var dummy = draw_markers();

</script>